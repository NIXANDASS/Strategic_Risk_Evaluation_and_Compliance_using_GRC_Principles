<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Controls ‚Äì {{ risk.risk_code }} | PaySecure GRC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0b0f1a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
        .topbar {
            background: #0d1117;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 14px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .topbar-brand {
            font-size: 15px;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-chip {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.45);
        }

        .user-chip strong {
            color: #c7d2fe;
            font-weight: 600;
        }

        .btn-ghost {
            padding: 7px 14px;
            border-radius: 7px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.55);
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #e2e8f0;
        }

        /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
        .main {
            max-width: 1280px;
            margin: 0 auto;
            padding: 28px 28px 60px;
        }

        /* ‚îÄ‚îÄ Risk banner ‚îÄ‚îÄ */
        .risk-banner {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e3a5f 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 14px;
            padding: 22px 26px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .risk-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .risk-code {
            font-size: 11px;
            font-weight: 700;
            color: rgba(165, 180, 252, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .risk-title {
            font-size: 20px;
            font-weight: 700;
            color: #f0f4ff;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 8px;
        }

        .level-High {
            background: rgba(239, 68, 68, .2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, .3);
        }

        .level-Medium {
            background: rgba(245, 158, 11, .2);
            color: #fde68a;
            border: 1px solid rgba(245, 158, 11, .3);
        }

        .level-Low {
            background: rgba(16, 185, 129, .2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, .3);
        }

        /* ‚îÄ‚îÄ Flash alerts ‚îÄ‚îÄ */
        .alert {
            padding: 11px 16px;
            border-radius: 9px;
            margin-bottom: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(16, 185, 129, .1);
            border: 1px solid rgba(16, 185, 129, .25);
            color: #6ee7b7;
        }

        .alert-danger {
            background: rgba(239, 68, 68, .1);
            border: 1px solid rgba(239, 68, 68, .25);
            color: #fca5a5;
        }

        .alert-warning {
            background: rgba(245, 158, 11, .1);
            border: 1px solid rgba(245, 158, 11, .25);
            color: #fde68a;
        }

        .alert-info {
            background: rgba(99, 102, 241, .1);
            border: 1px solid rgba(99, 102, 241, .25);
            color: #c7d2fe;
        }

        /* ‚îÄ‚îÄ Two-column grid ‚îÄ‚îÄ */
        .cols {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* ‚îÄ‚îÄ Panel ‚îÄ‚îÄ */
        .panel {
            background: #0d1117;
            border: 1px solid rgba(255, 255, 255, 0.07);
            border-radius: 14px;
            overflow: hidden;
        }

        .panel-head {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-head h2 {
            font-size: 12px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .count-badge {
            background: rgba(99, 102, 241, .15);
            border: 1px solid rgba(99, 102, 241, .2);
            color: #a5b4fc;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 9px;
            border-radius: 10px;
        }

        .panel-body {
            padding: 14px;
            max-height: 520px;
            overflow-y: auto;
        }

        /* ‚îÄ‚îÄ Search box ‚îÄ‚îÄ */
        .search-wrap {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            color: #e2e8f0;
            outline: none;
            font-family: inherit;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.25);
        }

        .search-input:focus {
            border-color: rgba(99, 102, 241, 0.4);
        }

        /* ‚îÄ‚îÄ Control item (available list) ‚îÄ‚îÄ */
        .ctrl-item {
            padding: 12px 14px;
            margin-bottom: 6px;
            border-radius: 9px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
            transition: all 0.18s;
        }

        .ctrl-item:hover {
            background: rgba(99, 102, 241, 0.08);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .ctrl-item .c-code {
            font-size: 11px;
            font-weight: 800;
            color: #a5b4fc;
            font-family: monospace;
            margin-bottom: 3px;
        }

        .ctrl-item .c-name {
            font-size: 13px;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 3px;
        }

        .ctrl-item .c-reg {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.25);
        }

        .empty-state .icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        /* ‚îÄ‚îÄ Map modal ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-box {
            background: #111827;
            border: 1px solid rgba(99, 102, 241, 0.25);
            border-radius: 16px;
            padding: 28px;
            width: 460px;
            max-width: 95vw;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: #f0f4ff;
            margin-bottom: 6px;
        }

        .modal-sub {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.35);
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
        }

        .form-select {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 9px 12px;
            font-size: 13px;
            color: #e2e8f0;
            font-family: inherit;
            outline: none;
            margin-bottom: 18px;
        }

        .form-select:focus {
            border-color: rgba(99, 102, 241, 0.4);
        }

        .form-select option {
            background: #1a1f2e;
        }

        .modal-selected-ctrl {
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 9px;
            padding: 12px 14px;
            margin-bottom: 18px;
        }

        .modal-selected-ctrl .c-code {
            font-size: 11px;
            font-weight: 800;
            color: #a5b4fc;
            font-family: monospace;
        }

        .modal-selected-ctrl .c-name {
            font-size: 13px;
            font-weight: 600;
            color: #e2e8f0;
            margin-top: 3px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 6px;
        }

        .btn-confirm {
            flex: 1;
            padding: 10px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 9px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }

        .btn-confirm:hover {
            background: #4f46e5;
        }

        .btn-cancel {
            padding: 10px 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 9px;
            color: rgba(255, 255, 255, 0.45);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.09);
        }

        /* ‚îÄ‚îÄ Mapped items list ‚îÄ‚îÄ */
        .mapped-item {
            padding: 12px 14px;
            margin-bottom: 6px;
            border-radius: 9px;
            border: 1px solid rgba(16, 185, 129, 0.15);
            background: rgba(16, 185, 129, 0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .mapped-item .m-info {
            flex: 1;
            min-width: 0;
        }

        .mapped-item .m-code {
            font-size: 11px;
            font-weight: 800;
            color: #34d399;
            font-family: monospace;
            margin-bottom: 3px;
        }

        .mapped-item .m-name {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mapped-item .m-type {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            background: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.2);
            white-space: nowrap;
        }

        .btn-remove {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.15);
            border-radius: 7px;
            color: #fca5a5;
            font-size: 11px;
            font-weight: 700;
            padding: 5px 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.18s;
            white-space: nowrap;
        }

        .btn-remove:hover {
            background: rgba(239, 68, 68, 0.18);
            border-color: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>

<body>
    <!-- Top Bar -->
    <nav class="topbar">
        <div class="topbar-brand">üîó PaySecure GRC ‚Äì Map Controls to Risk</div>
        <div class="topbar-right">
            <span class="user-chip">
                <strong>{{ session.get('username','user') }}</strong>
                &nbsp;¬∑&nbsp;{{ session.get('roles',[''])[0] | replace('_',' ') | title }}
            </span>
            <a href="{{ url_for('risk.register') }}" class="btn-ghost">‚Üê Risk Register</a>
            <a href="{{ url_for('compliance.controls') }}" class="btn-ghost">üìã Controls</a>
            <a href="{{ url_for('auth.logout') }}" class="btn-ghost">Sign Out</a>
        </div>
    </nav>

    <div class="main">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}{% for cat, msg in messages %}
        <div class="alert alert-{{ cat }}">{{ msg }}</div>
        {% endfor %}{% endif %}
        {% endwith %}

        <!-- Risk Banner -->
        <div class="risk-banner">
            <div class="risk-icon">‚ö†Ô∏è</div>
            <div>
                <div class="risk-code">{{ risk.risk_code }} ¬∑ {{ risk.category_name }}</div>
                <div class="risk-title">{{ risk.risk_title }}</div>
                <span class="level-badge level-{{ risk.risk_level }}">{{ risk.risk_level }} Risk</span>
            </div>
        </div>

        <!-- Two columns -->
        <div class="cols">

            <!-- ‚îÄ‚îÄ LEFT: Available Controls ‚îÄ‚îÄ -->
            <div class="panel">
                <div class="panel-head">
                    <h2>Available Controls</h2>
                    <span class="count-badge" id="availCount">
                        {{ controls | selectattr('control_id', 'ne', 0) | list | length - mapped_ids|length }} available
                    </span>
                </div>
                <div class="search-wrap">
                    <input type="text" class="search-input" id="searchBox"
                        placeholder="Search by code, name or framework‚Ä¶" oninput="filterControls()">
                </div>
                <div class="panel-body" id="availList">
                    {% set avail_count = namespace(n=0) %}
                    {% for ctrl in controls %}
                    {% if ctrl.control_id not in mapped_ids %}
                    {% set avail_count.n = avail_count.n + 1 %}
                    <div class="ctrl-item" data-code="{{ ctrl.control_code }}" data-name="{{ ctrl.control_name }}"
                        data-reg="{{ ctrl.regulation }}"
                        onclick="openModal({{ ctrl.control_id }}, '{{ ctrl.control_code|e }}', '{{ ctrl.control_name|replace("'","\\'")|e }}')">
                        <div class="c-code">{{ ctrl.control_code }}</div>
                        <div class="c-name">{{ ctrl.control_name }}</div>
                        <div class="c-reg">{{ ctrl.regulation | replace(' Guidelines 2020','') | replace(':2022','') }}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% if avail_count.n == 0 %}
                    <div class="empty-state">
                        <div class="icon">‚úÖ</div>
                        <div>All controls are mapped to this risk.</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ‚îÄ‚îÄ RIGHT: Mapped Controls ‚îÄ‚îÄ -->
            <div class="panel">
                <div class="panel-head">
                    <h2>Mapped Controls</h2>
                    <span class="count-badge">{{ existing_mappings|length }} mapped</span>
                </div>
                <div class="panel-body">
                    {% if existing_mappings %}
                    {% for m in existing_mappings %}
                    <div class="mapped-item">
                        <div class="m-info">
                            <div class="m-code">{{ m.control_code }}</div>
                            <div class="m-name">{{ m.control_name }}</div>
                        </div>
                        <span class="m-type">{{ m.mapping_type }}</span>
                        <form method="POST" action="{{ url_for('compliance.map_risk', risk_id=risk.risk_id) }}"
                            onsubmit="return confirm('Remove mapping for {{ m.control_code }}?')">
                            <input type="hidden" name="action" value="remove">
                            <input type="hidden" name="control_id" value="{{ m.control_id }}">
                            <input type="hidden" name="mapping_id" value="{{ m.mapping_id }}">
                            <button type="submit" class="btn-remove">‚úï Remove</button>
                        </form>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <div>No controls mapped yet.</div>
                        <div style="font-size:12px;margin-top:8px;">Click a control on the left to map it.</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div><!-- /cols -->
    </div><!-- /main -->

    <!-- ‚îÄ‚îÄ Map Confirmation Modal ‚îÄ‚îÄ -->
    <div class="modal-overlay" id="mapModal">
        <div class="modal-box">
            <div class="modal-title">Map Control to Risk</div>
            <div class="modal-sub">{{ risk.risk_code }} ¬∑ {{ risk.risk_title }}</div>

            <div class="modal-selected-ctrl" id="modalCtrlInfo">
                <div class="c-code" id="modalCtrlCode"></div>
                <div class="c-name" id="modalCtrlName"></div>
            </div>

            <form method="POST" action="{{ url_for('compliance.map_risk', risk_id=risk.risk_id) }}" id="mapForm">
                <input type="hidden" name="action" value="add">
                <input type="hidden" name="control_id" id="modalControlId">

                <label class="form-label">Mapping Type</label>
                <select name="mapping_type" class="form-select">
                    <option value="Mitigating">Mitigating ‚Äì control reduces the risk</option>
                    <option value="Compensating">Compensating ‚Äì alternative workaround control</option>
                    <option value="Detective">Detective ‚Äì detects when risk occurs</option>
                    <option value="Preventive">Preventive ‚Äì stops the risk from occurring</option>
                </select>

                <div class="modal-actions">
                    <button type="submit" class="btn-confirm">üîó Confirm Mapping</button>
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openModal(controlId, controlCode, controlName) {
            document.getElementById('modalControlId').value = controlId;
            document.getElementById('modalCtrlCode').textContent = controlCode;
            document.getElementById('modalCtrlName').textContent = controlName;
            document.getElementById('mapModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('mapModal').classList.remove('open');
        }

        // Close modal on overlay click
        document.getElementById('mapModal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        // Live search filter
        function filterControls() {
            const q = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('#availList .ctrl-item');
            let visible = 0;
            items.forEach(item => {
                const text = (item.dataset.code + ' ' + item.dataset.name + ' ' + item.dataset.reg).toLowerCase();
                const show = text.includes(q);
                item.style.display = show ? '' : 'none';
                if (show) visible++;
            });
        }
    </script>
</body>

</html>